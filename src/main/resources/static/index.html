<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>LogCollector Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
<div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">LogCollector Admin</h1>

    <div class="flex border-b border-gray-200 mb-6">
        <button onclick="showTab('logs')" id="tab-logs"
                class="px-6 py-2 font-bold border-b-2 border-blue-600 text-blue-600">Logs
        </button>
        <button onclick="showTab('incidents')" id="tab-incidents"
                class="px-6 py-2 font-bold text-gray-500 border-b-2 border-transparent">Incidents
        </button>
        <button onclick="showTab('kb')" id="tab-kb"
                class="px-6 py-2 font-bold text-gray-500 border-b-2 border-transparent">KB
        </button>
        <button onclick="showTab('debug')" id="tab-debug"
                class="px-6 py-2 font-bold text-gray-500 border-b-2 border-transparent">Debug
        </button>
    </div>

    <!-- Logs -->
    <div id="content-logs">
        <div class="bg-white p-6 rounded shadow mb-6 border-t-4 border-green-500">
            <h2 class="text-lg font-bold mb-4">수동 로그 등록 (POST /api/logs)</h2>
            <div class="grid grid-cols-4 gap-3 mb-3">
                <input type="text" id="newService" class="border p-2 rounded" placeholder="서비스명 (예: Order-API)">
                <select id="newLogLevel" class="border p-2 rounded">
                    <option value="">로그 레벨 자동 탐지</option>
                    <option value="INFO">INFO</option>
                    <option value="WARN">WARN</option>
                    <option value="ERROR">ERROR</option>
                    <option value="CRITICAL">CRITICAL</option>
                    <option value="FATAL">FATAL</option>
                </select>
                <input type="text" id="newHost" class="border p-2 rounded" placeholder="호스트명">
                <input type="text" id="newIp" class="border p-2 rounded" placeholder="IP(옵션)">
            </div>
            <textarea id="newMessage" class="border p-2 rounded w-full h-20 mb-3"
                      placeholder="에러 메시지 (10자 이상 권장)"></textarea>
            <textarea id="newStackTrace" class="border p-2 rounded w-full h-20 mb-4 font-mono text-xs"
                      placeholder="StackTrace(옵션)"></textarea>
            <button onclick="createLog()"
                    class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 font-bold">
                로그 전송
            </button>
            <p class="mt-2 text-xs text-gray-500">
                서버는 검증 후 Redis 큐에 적재하고, Consumer가 DB 저장합니다. (202 Accepted 예상)
            </p>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6 flex flex-wrap gap-4 items-end">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">서비스명(serviceName)</label>
                <input type="text" id="filterService" class="border p-2 rounded text-sm w-56" placeholder="전체">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">상태(status)</label>
                <select id="filterStatus" class="border p-2 rounded text-sm w-40">
                    <option value="">전체</option>
                    <option value="NEW">NEW</option>
                    <option value="RESOLVED">RESOLVED</option>
                    <option value="IGNORED">IGNORED</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">오늘만(isToday)</label>
                <select id="filterIsToday" class="border p-2 rounded text-sm w-28">
                    <option value="false">false</option>
                    <option value="true">true</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">페이지</label>
                <div class="flex gap-2">
                    <input type="number" id="logsPage" class="border p-2 rounded text-sm w-24" value="0" min="0">
                    <input type="number" id="logsSize" class="border p-2 rounded text-sm w-24" value="20" min="1"
                           max="200">
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">정렬(sort)</label>
                <select id="logsSort" class="border p-2 rounded text-sm w-56">
                    <option value="occurredTime,desc">occurredTime,desc</option>
                    <option value="occurredTime,asc">occurredTime,asc</option>
                    <option value="createdAt,desc">createdAt,desc</option>
                    <option value="createdAt,asc">createdAt,asc</option>
                </select>
            </div>

            <button onclick="loadLogs()"
                    class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-bold text-sm">
                조회/새로고침 (GET /api/logs)
            </button>
        </div>

        <div class="bg-white rounded shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left">서비스/레벨</th>
                    <th class="px-6 py-3 text-left">요약/해시</th>
                    <th class="px-6 py-3 text-left">상태</th>
                    <th class="px-6 py-3 text-left">상태 변경 (PATCH)</th>
                </tr>
                </thead>
                <tbody id="logList" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
            <div class="p-4 text-xs text-gray-500 flex justify-between items-center">
                <span id="logsMeta">-</span>
                <div class="flex gap-2">
                    <button class="px-3 py-1 bg-gray-200 rounded" onclick="logsPrev()">Prev</button>
                    <button class="px-3 py-1 bg-gray-200 rounded" onclick="logsNext()">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Incidents -->
    <div id="content-incidents" class="hidden">
        <div class="bg-white p-6 rounded shadow mb-6 border-t-4 border-orange-500">
            <h2 class="text-lg font-bold mb-4">Incidents 목록 (GET /api/incidents)</h2>

            <div class="flex flex-wrap gap-3 items-end mb-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">페이지</label>
                    <div class="flex gap-2">
                        <input type="number" id="incPage" class="border p-2 rounded text-sm w-24" value="0" min="0">
                        <input type="number" id="incSize" class="border p-2 rounded text-sm w-24" value="20" min="1"
                               max="200">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">정렬(sort)</label>
                    <select id="incSort" class="border p-2 rounded text-sm w-64">
                        <option value="lastOccurredAt,desc">lastOccurredAt,desc</option>
                        <option value="repeatCount,desc">repeatCount,desc</option>
                        <option value="firstOccurredAt,desc">firstOccurredAt,desc</option>
                    </select>
                </div>
                <button onclick="loadIncidents()"
                        class="bg-orange-500 text-white px-6 py-2 rounded hover:bg-orange-600 font-bold">
                    목록 조회
                </button>
            </div>

            <div class="grid grid-cols-3 gap-4 mb-4 bg-gray-50 p-3 rounded border">
                <div class="col-span-3 font-bold text-sm text-gray-700">logHash 단건 조회 (GET /api/incidents/{logHash})
                </div>
                <input type="text" id="incLogHash" class="border p-2 rounded col-span-2"
                       placeholder="logHash 입력 후 조회">
                <button onclick="getIncidentByHash()"
                        class="bg-gray-800 text-white px-6 py-2 rounded hover:bg-black font-bold">
                    단건 조회
                </button>
                <pre id="incidentOne"
                     class="col-span-3 bg-white border rounded p-3 text-xs overflow-auto max-h-52"></pre>
            </div>

            <div class="grid grid-cols-6 gap-3 mb-4 bg-gray-50 p-3 rounded border">
                <div class="col-span-6 font-bold text-sm text-gray-700">랭킹 (GET /api/incidents/top)</div>

                <div class="col-span-2">
                    <label class="block text-xs font-bold text-gray-500 mb-1">metric</label>
                    <select id="topMetric" class="border p-2 rounded text-sm w-full">
                        <option value="repeatCount">repeatCount</option>
                        <option value="hostCount">hostCount</option>
                        <option value="lastOccurredAt">lastOccurredAt</option>
                    </select>
                </div>
                <div class="col-span-1">
                    <label class="block text-xs font-bold text-gray-500 mb-1">limit</label>
                    <input type="number" id="topLimit" class="border p-2 rounded text-sm w-full" value="20" min="1"
                           max="200">
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-bold text-gray-500 mb-1">serviceName (옵션)</label>
                    <input type="text" id="topService" class="border p-2 rounded text-sm w-full" placeholder="전체">
                </div>
                <div class="col-span-1">
                    <label class="block text-xs font-bold text-gray-500 mb-1">status (옵션)</label>
                    <select id="topStatus" class="border p-2 rounded text-sm w-full">
                        <option value="">(없음)</option>
                        <option value="OPEN">OPEN</option>
                        <option value="RESOLVED">RESOLVED</option>
                    </select>
                </div>

                <div class="col-span-3">
                    <label class="block text-xs font-bold text-gray-500 mb-1">from (옵션, ISO:
                        2026-01-01T00:00:00)</label>
                    <input type="text" id="topFrom" class="border p-2 rounded text-sm w-full"
                           placeholder="예: 2026-01-01T00:00:00">
                </div>
                <div class="col-span-3">
                    <label class="block text-xs font-bold text-gray-500 mb-1">to (옵션, ISO)</label>
                    <input type="text" id="topTo" class="border p-2 rounded text-sm w-full"
                           placeholder="예: 2026-02-01T00:00:00">
                </div>

                <div class="col-span-6 flex justify-end">
                    <button onclick="loadTop()"
                            class="bg-orange-600 text-white px-6 py-2 rounded hover:bg-orange-700 font-bold">
                        랭킹 조회
                    </button>
                </div>

                <div class="col-span-6 overflow-auto">
                    <table class="min-w-full text-sm bg-white rounded border">
                        <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left">rank</th>
                            <th class="px-3 py-2 text-left">incidentId</th>
                            <th class="px-3 py-2 text-left">service</th>
                            <th class="px-3 py-2 text-left">status</th>
                            <th class="px-3 py-2 text-left">metric</th>
                            <th class="px-3 py-2 text-left">hostCount</th>
                            <th class="px-3 py-2 text-left">logHash</th>
                        </tr>
                        </thead>
                        <tbody id="topList" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded shadow overflow-hidden">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left">ID</th>
                        <th class="px-6 py-3 text-left">서비스</th>
                        <th class="px-6 py-3 text-left">상태</th>
                        <th class="px-6 py-3 text-left">repeat</th>
                        <th class="px-6 py-3 text-left">lastOccurredAt</th>
                        <th class="px-6 py-3 text-left">logHash</th>
                    </tr>
                    </thead>
                    <tbody id="incidentList" class="divide-y divide-gray-200"></tbody>
                </table>
                <div class="p-4 text-xs text-gray-500 flex justify-between items-center">
                    <span id="incMeta">-</span>
                    <div class="flex gap-2">
                        <button class="px-3 py-1 bg-gray-200 rounded" onclick="incPrev()">Prev</button>
                        <button class="px-3 py-1 bg-gray-200 rounded" onclick="incNext()">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KB -->
    <div id="content-kb" class="hidden">
        <div class="bg-white p-6 rounded shadow mb-6 border-t-4 border-purple-500">
            <h2 class="text-lg font-bold mb-4">KB Drafts/Articles</h2>

            <div class="grid grid-cols-6 gap-3 mb-4 bg-gray-50 p-3 rounded border">
                <div class="col-span-6 font-bold text-sm text-gray-700">
                    Draft 생성 (POST /api/kb/draft?incidentId=...)
                </div>
                <input type="number" id="draftIncidentId" class="border p-2 rounded col-span-4"
                       placeholder="incidentId">
                <button onclick="createDraft()"
                        class="bg-purple-700 text-white px-6 py-2 rounded hover:bg-purple-800 font-bold col-span-2">
                    Draft 생성
                </button>
                <p class="col-span-6 text-xs text-gray-500">
                    상태 RESOLVED 흐름을 타면 자동으로 Draft가 생성될 수도 있지만, 여기서는 수동 테스트를 지원합니다.
                </p>
            </div>

            <div class="flex flex-wrap gap-3 items-end mb-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">페이지</label>
                    <div class="flex gap-2">
                        <input type="number" id="kbPage" class="border p-2 rounded text-sm w-24" value="0" min="0">
                        <input type="number" id="kbSize" class="border p-2 rounded text-sm w-24" value="20" min="1"
                               max="200">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">정렬(sort)</label>
                    <select id="kbSort" class="border p-2 rounded text-sm w-64">
                        <option value="createdAt,desc">createdAt,desc</option>
                        <option value="createdAt,asc">createdAt,asc</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[260px]">
                    <label class="block text-xs font-bold text-gray-500 mb-1">클라이언트 필터(옵션): 제목 포함</label>
                    <input type="text" id="kbClientKeyword" class="border p-2 rounded text-sm w-full"
                           placeholder="서버 필터 API가 없어서 클라이언트에서만 필터링">
                </div>
                <button onclick="loadKb()"
                        class="bg-purple-500 text-white px-6 py-2 rounded hover:bg-purple-600 font-bold">
                    목록 조회 (GET /api/kb)
                </button>
            </div>

            <div class="bg-white rounded shadow overflow-hidden">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left">ID</th>
                        <th class="px-6 py-3 text-left">Title(현상)</th>
                        <th class="px-6 py-3 text-left">Status</th>
                        <th class="px-6 py-3 text-left">CreatedBy</th>
                        <th class="px-6 py-3 text-left">CreatedAt</th>
                        <th class="px-6 py-3 text-left">관리</th>
                    </tr>
                    </thead>
                    <tbody id="kbList" class="divide-y divide-gray-200"></tbody>
                </table>
                <div class="p-4 text-xs text-gray-500 flex justify-between items-center">
                    <span id="kbMeta">-</span>
                    <div class="flex gap-2">
                        <button class="px-3 py-1 bg-gray-200 rounded" onclick="kbPrev()">Prev</button>
                        <button class="px-3 py-1 bg-gray-200 rounded" onclick="kbNext()">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug -->
    <div id="content-debug" class="hidden">
        <div class="bg-white p-6 rounded shadow border-t-4 border-gray-600">
            <h2 class="text-lg font-bold mb-4">Debug Console</h2>
            <div class="flex gap-2 mb-3">
                <button class="px-4 py-2 bg-gray-800 text-white rounded" onclick="clearConsole()">Clear</button>
                <button class="px-4 py-2 bg-gray-200 rounded" onclick="dumpState()">Dump UI State</button>
            </div>
            <pre id="console" class="bg-black text-green-200 p-4 rounded text-xs overflow-auto max-h-[70vh]"></pre>
        </div>
    </div>

    <!-- Modal -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800">상세 정보</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div id="modalBody" class="p-6"></div>
            <div class="p-6 border-t bg-gray-50 flex justify-end gap-3" id="modalFooter">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded">닫기</button>
            </div>
        </div>
    </div>

</div>

<script>
    // ---- UI helpers ----
    function logConsole(...args) {
      const el = document.getElementById('console');
      const line = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a, null, 2))).join(' ');
      el.textContent += `[${new Date().toISOString()}] ${line}\n`;
      el.scrollTop = el.scrollHeight;
    }
    function clearConsole() {
      document.getElementById('console').textContent = '';
    }
    function dumpState() {
      const state = {
        logs: {
          serviceName: v('filterService'),
          status: v('filterStatus'),
          isToday: v('filterIsToday'),
          page: v('logsPage'),
          size: v('logsSize'),
          sort: v('logsSort')
        },
        incidents: {
          page: v('incPage'),
          size: v('incSize'),
          sort: v('incSort')
        },
        kb: {
          page: v('kbPage'),
          size: v('kbSize'),
          sort: v('kbSort'),
          clientKeyword: v('kbClientKeyword')
        }
      };
      logConsole('STATE', state);
    }
    function v(id) { return document.getElementById(id).value; }

    function showTab(tabName) {
      ['logs', 'incidents', 'kb', 'debug'].forEach(name => {
        document.getElementById(`content-${name}`).classList.add('hidden');
        document.getElementById(`tab-${name}`).className = 'px-6 py-2 font-bold text-gray-500 border-b-2 border-transparent';
      });
      document.getElementById(`content-${tabName}`).classList.remove('hidden');
      document.getElementById(`tab-${tabName}`).className = 'px-6 py-2 font-bold border-b-2 border-blue-600 text-blue-600';

      if (tabName === 'logs') loadLogs();
      if (tabName === 'incidents') loadIncidents();
      if (tabName === 'kb') loadKb();
    }

    async function fetchJson(url, options) {
      logConsole('HTTP', (options?.method || 'GET'), url);
      const res = await fetch(url, options);
      const text = await res.text();
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch (_) {}

      if (!res.ok) {
        logConsole('ERROR', res.status, res.statusText, json || text);
        throw new Error(`${res.status} ${res.statusText}`);
      }
      logConsole('OK', res.status, json || text);
      return json;
    }

    // ---- Logs API ----
    const LOGS_BASE = '/api/logs';

    async function createLog() {
      const payload = {
        serviceName: v('newService'),
        logLevel: v('newLogLevel'),
        message: v('newMessage'),
        hostName: v('newHost'),
        ip: v('newIp'),
        stackTrace: v('newStackTrace')
      };
      if (!payload.serviceName || !payload.message) return alert('서비스명과 메시지를 입력하세요.');

      try {
        await fetchJson(LOGS_BASE, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        alert('로그 전송 성공 (Accepted 예상). Consumer 처리 후 목록에 반영됩니다.');
        setTimeout(loadLogs, 500);
      } catch (e) {
        alert('전송 실패: 콘솔 확인');
      }
    }

    async function loadLogs() {
      const params = new URLSearchParams();
      const service = v('filterService').trim();
      const status = v('filterStatus').trim();
      const isToday = v('filterIsToday');
      const page = v('logsPage');
      const size = v('logsSize');
      const sort = v('logsSort');

      if (service) params.set('serviceName', service);
      if (status) params.set('status', status);
      params.set('isToday', isToday);
      params.set('page', page);
      params.set('size', size);
      if (sort) params.set('sort', sort);

      try {
        const data = await fetchJson(`${LOGS_BASE}?${params.toString()}`);
        const tbody = document.getElementById('logList');

        document.getElementById('logsMeta').innerText =
          `page=${data.number} size=${data.size} totalElements=${data.totalElements} totalPages=${data.totalPages}`;

        tbody.innerHTML = (data.content || []).map(log => {
          const hash = log.logHash || '';
          const summary = log.summary || '';
          return `
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4">
                <div class="font-bold">${escapeHtml(log.serviceName || '')}</div>
                <div class="text-xs text-gray-500">${escapeHtml(log.logLevel || '')}</div>
              </td>
              <td class="px-6 py-4">
                <div class="truncate max-w-md">${escapeHtml(summary)}</div>
                <div class="text-[11px] text-gray-500 mt-1">hash: ${escapeHtml(hash)}</div>
              </td>
              <td class="px-6 py-4">
                <span class="px-2 py-1 rounded text-xs bg-blue-50 text-blue-700">${escapeHtml(log.status || '')}</span>
              </td>
              <td class="px-6 py-4">
                <select onchange="updateStatus(${log.logId}, this.value)"
                        class="border rounded p-1 text-xs">
                  <option value="NEW" ${log.status === 'NEW' ? 'selected' : ''}>NEW</option>
                  <option value="RESOLVED" ${log.status === 'RESOLVED' ? 'selected' : ''}>RESOLVED</option>
                  <option value="IGNORED" ${log.status === 'IGNORED' ? 'selected' : ''}>IGNORED</option>
                </select>
                <button class="ml-2 text-blue-600 hover:underline text-xs"
                        onclick="alert('logId=${log.logId}\\nlogHash=${hash}\\nsummary=${summary}')">info</button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        document.getElementById('logList').innerHTML = '';
        document.getElementById('logsMeta').innerText = '로드 실패 (콘솔 확인)';
      }
    }

    async function updateStatus(id, status) {
      try {
        await fetchJson(`${LOGS_BASE}/${id}/status?newStatus=${encodeURIComponent(status)}`, { method: 'PATCH' });
        alert('상태 업데이트 완료');
        setTimeout(() => { loadLogs(); loadKb(); loadIncidents(); }, 300);
      } catch (e) {
        alert('상태 업데이트 실패: 콘솔 확인');
      }
    }

    function logsPrev() {
      const p = Math.max(0, parseInt(v('logsPage') || '0', 10) - 1);
      document.getElementById('logsPage').value = String(p);
      loadLogs();
    }
    function logsNext() {
      const p = Math.max(0, parseInt(v('logsPage') || '0', 10) + 1);
      document.getElementById('logsPage').value = String(p);
      loadLogs();
    }

    // ---- Incidents API ----
    async function loadIncidents() {
      const page = v('incPage');
      const size = v('incSize');
      const sort = v('incSort');

      const params = new URLSearchParams();
      params.set('page', page);
      params.set('size', size);
      if (sort) params.set('sort', sort);

      try {
        const data = await fetchJson(`/api/incidents?${params.toString()}`);
        document.getElementById('incMeta').innerText =
          `page=${data.number} size=${data.size} totalElements=${data.totalElements} totalPages=${data.totalPages}`;

        document.getElementById('incidentList').innerHTML = (data.content || []).map(inc => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-3">${inc.id ?? ''}</td>
            <td class="px-6 py-3">${escapeHtml(inc.serviceName || '')}</td>
            <td class="px-6 py-3">
              <span class="px-2 py-1 rounded text-xs bg-orange-50 text-orange-700">${escapeHtml(inc.status || '')}</span>
            </td>
            <td class="px-6 py-3">${inc.repeatCount ?? ''}</td>
            <td class="px-6 py-3 text-xs text-gray-600">${fmtDate(inc.lastOccurredAt)}</td>
            <td class="px-6 py-3 text-xs font-mono">
              ${escapeHtml(inc.logHash || '')}
              <button class="ml-2 text-blue-600 hover:underline"
                      onclick="document.getElementById('incLogHash').value='${escapeAttr(inc.logHash || '')}'; getIncidentByHash();">
                보기
              </button>
            </td>
          </tr>
        `).join('');
      } catch (e) {
        document.getElementById('incidentList').innerHTML = '';
        document.getElementById('incMeta').innerText = '로드 실패 (콘솔 확인)';
      }
    }

    async function getIncidentByHash() {
      const hash = v('incLogHash').trim();
      if (!hash) return alert('logHash를 입력하세요.');

      try {
        const data = await fetchJson(`/api/incidents/${encodeURIComponent(hash)}`);
        document.getElementById('incidentOne').textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        document.getElementById('incidentOne').textContent = '조회 실패 (콘솔 확인)';
      }
    }

    async function loadTop() {
      const params = new URLSearchParams();
      params.set('metric', v('topMetric'));
      params.set('limit', v('topLimit'));

      const serviceName = v('topService').trim();
      const status = v('topStatus').trim();
      const from = v('topFrom').trim();
      const to = v('topTo').trim();

      if (serviceName) params.set('serviceName', serviceName);
      if (status) params.set('status', status);
      if (from) params.set('from', from);
      if (to) params.set('to', to);

      try {
        const list = await fetchJson(`/api/incidents/top?${params.toString()}`);
        document.getElementById('topList').innerHTML = (list || []).map((r, idx) => `
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-2">${idx + 1}</td>
            <td class="px-3 py-2">${r.incidentId ?? r.id ?? ''}</td>
            <td class="px-3 py-2">${escapeHtml(r.serviceName || '')}</td>
            <td class="px-3 py-2">${escapeHtml(r.status || '')}</td>
            <td class="px-3 py-2">${escapeHtml(String(r.metric ?? r.metricName ?? ''))}: ${escapeHtml(String(r.value ?? r.metricValue ?? ''))}</td>
            <td class="px-3 py-2">${r.hostCount ?? ''}</td>
            <td class="px-3 py-2 font-mono text-xs">${escapeHtml(r.logHash || '')}</td>
          </tr>
        `).join('');
      } catch (e) {
        document.getElementById('topList').innerHTML = '';
      }
    }

    function incPrev() {
      const p = Math.max(0, parseInt(v('incPage') || '0', 10) - 1);
      document.getElementById('incPage').value = String(p);
      loadIncidents();
    }
    function incNext() {
      const p = Math.max(0, parseInt(v('incPage') || '0', 10) + 1);
      document.getElementById('incPage').value = String(p);
      loadIncidents();
    }

    // ---- KB API ----
    async function createDraft() {
      const incidentId = v('draftIncidentId').trim();
      if (!incidentId) return alert('incidentId를 입력하세요.');

      try {
        const id = await fetchJson(`/api/kb/draft?incidentId=${encodeURIComponent(incidentId)}`, { method: 'POST' });
        alert(`Draft 생성 완료: kbArticleId=${id}`);
        showTab('kb');
        setTimeout(loadKb, 300);
      } catch (e) {
        alert('Draft 생성 실패: 콘솔 확인');
      }
    }

    async function loadKb() {
      const page = v('kbPage');
      const size = v('kbSize');
      const sort = v('kbSort');
      const keyword = v('kbClientKeyword').trim().toLowerCase();

      const params = new URLSearchParams();
      params.set('page', page);
      params.set('size', size);
      if (sort) params.set('sort', sort);

      try {
        const data = await fetchJson(`/api/kb?${params.toString()}`);

        document.getElementById('kbMeta').innerText =
          `page=${data.number} size=${data.size} totalElements=${data.totalElements} totalPages=${data.totalPages}`;

        let rows = data.content || [];
        // 서버 필터 API가 없으므로, 제목 키워드만 클라이언트에서 필터링
        if (keyword) {
          rows = rows.filter(x => (x.title || '').toLowerCase().includes(keyword));
        }

        document.getElementById('kbList').innerHTML = rows.map(kb => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-3">${kb.id ?? ''}</td>
            <td class="px-6 py-3 font-bold">${escapeHtml(kb.title || '제목 없음')}</td>
            <td class="px-6 py-3">
              <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">${escapeHtml(kb.status || '')}</span>
            </td>
            <td class="px-6 py-3 text-xs text-gray-600">${escapeHtml(kb.createdBy || '')}</td>
            <td class="px-6 py-3 text-xs text-gray-600">${fmtDate(kb.createdAt)}</td>
            <td class="px-6 py-3">
              <button onclick="openKbDetail(${kb.id})" class="text-purple-700 hover:underline">상세/편집</button>
            </td>
          </tr>
        `).join('');
      } catch (e) {
        document.getElementById('kbList').innerHTML = '';
        document.getElementById('kbMeta').innerText = '로드 실패 (콘솔 확인)';
      }
    }

    async function openKbDetail(id) {
      try {
        const kb = await fetchJson(`/api/kb/${id}`);

        // ERR kb 상세 응답은 incidentTitle/content/status/createdAt/createdBy 등을 포함
        document.getElementById('modalTitle').innerText = `KB 상세 (#${id})`;

        document.getElementById('modalBody').innerHTML = `
          <div class="grid grid-cols-3 gap-4 mb-4 text-xs bg-gray-50 p-3 rounded border">
            <div><span class="font-bold">작성자:</span> ${escapeHtml(kb.createdBy || 'Unknown')}</div>
            <div><span class="font-bold">상태:</span> ${escapeHtml(kb.status || '')}</div>
            <div><span class="font-bold">생성일:</span> ${fmtDate(kb.createdAt)}</div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-bold mb-1">장애 현상 (Title)</label>
            <input type="text" id="editKbTitle" value="${escapeAttr(kb.incidentTitle || '')}" class="w-full border p-2 rounded">
          </div>

          <div class="mb-4">
            <label class="block text-sm font-bold mb-1">해결 방안 (Content)</label>
            <textarea id="editKbContent" rows="12" class="w-full border p-2 rounded font-mono text-sm">${escapeHtml(kb.content || '')}</textarea>
          </div>

          <div class="grid grid-cols-2 gap-3 text-xs bg-gray-50 p-3 rounded border">
            <button class="px-4 py-2 bg-indigo-600 text-white rounded font-bold"
                    onclick="saveDraft(${id})">
              Draft 저장 (POST /api/kb/draft/${id})
            </button>
            <button class="px-4 py-2 bg-purple-700 text-white rounded font-bold"
                    onclick="postArticle(${id})">
              게시/전환 (POST /api/kb/articles/${id})
            </button>
            <div class="col-span-2 text-gray-600">
              - Draft 저장: 초안 업데이트용<br/>
              - 게시/전환: 사용자 글로 전환(서비스 구현에 따라 status/createdBy가 바뀌는지 확인)
            </div>
          </div>
        `;

        document.getElementById('modalFooter').innerHTML = `
          <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded">닫기</button>
        `;

        document.getElementById('detailModal').classList.remove('hidden');
      } catch (e) {
        alert('KB 상세 조회 실패: 콘솔 확인');
      }
    }

    async function saveDraft(id) {
      const title = document.getElementById('editKbTitle').value;
      const content = document.getElementById('editKbContent').value;

      try {
        await fetchJson(`/api/kb/draft/${id}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ title, content })
        });
        alert('Draft 저장 완료');
        closeModal();
        loadKb();
      } catch (e) {
        alert('Draft 저장 실패: 콘솔 확인');
      }
    }

    async function postArticle(id) {
      const title = document.getElementById('editKbTitle').value;
      const content = document.getElementById('editKbContent').value;

      try {
        await fetchJson(`/api/kb/articles/${id}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ title, content })
        });
        alert('게시/전환 요청 완료');
        closeModal();
        loadKb();
      } catch (e) {
        alert('게시/전환 실패: 콘솔 확인');
      }
    }

    function kbPrev() {
      const p = Math.max(0, parseInt(v('kbPage') || '0', 10) - 1);
      document.getElementById('kbPage').value = String(p);
      loadKb();
    }
    function kbNext() {
      const p = Math.max(0, parseInt(v('kbPage') || '0', 10) + 1);
      document.getElementById('kbPage').value = String(p);
      loadKb();
    }

    // ---- Modal ----
    function closeModal() {
      document.getElementById('detailModal').classList.add('hidden');
    }

    // ---- Utils ----
function fmtDate(v) {
    if (!v) return '';
    // LocalDateTime이 배열로 오는 경우: [yyyy,MM,dd,HH,mm,ss,...]
    if (Array.isArray(v) && v.length >= 3) {
      const [y, m, d, hh = 0, mm = 0, ss = 0] = v;
      return new Date(y, (m - 1), d, hh, mm, ss).toLocaleString();
    }
    // ISO 문자열로 오는 경우
    return new Date(v).toLocaleString();
  }
    }
    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
    function escapeAttr(s) {
      // attribute용 최소 escaping
      return escapeHtml(s).replaceAll('\n', '&#10;');
    }

    // 초기 로드
    window.onload = () => {
      clearConsole();
      showTab('logs');
    };
</script>
</body>
</html>
