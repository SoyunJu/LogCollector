<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>LogCollector Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
<div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">LogCollector Admin</h1>

    <div class="flex border-b border-gray-200 mb-6">
        <button onclick="showTab('logs')" id="tab-logs"
                class="px-6 py-2 font-bold border-b-2 border-blue-600 text-blue-600">Logs & Registration
        </button>
        <button onclick="showTab('incidents')" id="tab-incidents"
                class="px-6 py-2 font-bold text-gray-500 border-b-2 border-transparent">Incidents
        </button>
        <button onclick="showTab('kb')" id="tab-kb"
                class="px-6 py-2 font-bold text-gray-500 border-b-2 border-transparent">KB Drafts
        </button>
    </div>

    <div id="content-logs">
        <div class="bg-white p-6 rounded shadow mb-6 border-t-4 border-green-500">
            <h2 class="text-lg font-bold mb-4">ğŸ“ ìˆ˜ë™ ë¡œê·¸ ë“±ë¡ (í…ŒìŠ¤íŠ¸)</h2>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <input type="text" id="newService" class="border p-2 rounded" placeholder="ì„œë¹„ìŠ¤ëª… (ì˜ˆ: OrderService)">
                <select id="newLogLevel" class="border p-2 rounded">
                    <option value="">ë¡œê·¸ ë ˆë²¨ ìë™ íƒì§€</option>
                    <option value="INFO">INFO (ìˆ˜ì§‘ ì œì™¸ í…ŒìŠ¤íŠ¸)</option>
                    <option value="ERROR">ERROR</option>
                    <option value="CRITICAL">CRITICAL</option>
                    <option value="FATAL">FATAL</option>
                </select>
                <input type="text" id="newHost" class="border p-2 rounded" placeholder="í˜¸ìŠ¤íŠ¸ëª…">
            </div>
            <textarea id="newMessage" class="border p-2 rounded w-full h-20 mb-4" placeholder="ì—ëŸ¬ ë©”ì‹œì§€ (10ì ì´ìƒ)"></textarea>
            <button onclick="createLog()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 font-bold">ë¡œê·¸ ì „ì†¡</button>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6 flex gap-4 items-end">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ì„œë¹„ìŠ¤ëª… í•„í„°</label>
                <input type="text" id="filterService" class="border p-2 rounded text-sm w-48" placeholder="ì „ì²´">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ìƒíƒœ í•„í„°</label>
                <select id="filterStatus" class="border p-2 rounded text-sm w-32">
                    <option value="">ì „ì²´ ìƒíƒœ</option>
                    <option value="NEW">NEW</option>
                    <option value="ACKNOWLEDGED">ACK</option>
                    <option value="RESOLVED">RESOLVED</option>
                </select>
            </div>
            <button onclick="loadLogs()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-bold text-sm">ì¡°íšŒ/ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div class="bg-white rounded shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left">ì„œë¹„ìŠ¤/ë ˆë²¨</th>
                    <th class="px-6 py-3 text-left">ë©”ì‹œì§€ ìš”ì•½</th>
                    <th class="px-6 py-3 text-left">ìƒíƒœ ë³€ê²½</th>
                    <th class="px-6 py-3 text-left">ì•¡ì…˜</th>
                </tr>
                </thead>
                <tbody id="logList" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <div id="content-incidents" class="hidden">
        <div class="bg-white rounded shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left">ì¸ì‹œë˜íŠ¸ ID</th>
                    <th class="px-6 py-3 text-left">ì„œë¹„ìŠ¤ëª…</th>
                    <th class="px-6 py-3 text-left">ì œëª©</th>
                    <th class="px-6 py-3 text-left">ìƒíƒœ</th>
                </tr>
                </thead>
                <tbody id="incidentList" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <div id="content-kb" class="hidden">
        <div class="bg-white rounded shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left">KB ID</th>
                    <th class="px-6 py-3 text-left">ì œëª©</th>
                    <th class="px-6 py-3 text-left">ìƒíƒœ</th>
                    <th class="px-6 py-3 text-left">ìƒì„±ì¼</th>
                </tr>
                </thead>
                <tbody id="kbList" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api/logs';

    // íƒ­ ì „í™˜ ë¡œì§
    function showTab(tabName) {
        ['logs', 'incidents', 'kb'].forEach(name => {
            const content = document.getElementById(`content-${name}`);
            const tabBtn = document.getElementById(`tab-${name}`);
            if (content) content.classList.add('hidden');
            if (tabBtn) tabBtn.className = 'px-6 py-2 font-bold text-gray-500 border-b-2 border-transparent';
        });

        const activeContent = document.getElementById(`content-${tabName}`);
        const activeTab = document.getElementById(`tab-${tabName}`);
        if (activeContent) activeContent.classList.remove('hidden');
        if (activeTab) activeTab.className = 'px-6 py-2 font-bold border-b-2 border-blue-600 text-blue-600';

        if (tabName === 'logs') loadLogs();
        if (tabName === 'incidents') loadIncidents();
        if (tabName === 'kb') loadKb();
    }

    // ë¡œê·¸ ëª©ë¡ ë¡œë“œ
    async function loadLogs() {
        const service = document.getElementById('filterService').value;
        const status = document.getElementById('filterStatus').value;
        const params = new URLSearchParams({ size: 20 });
        if (service.trim()) params.append('serviceName', service.trim());
        if (status) params.append('status', status);

        try {
            const res = await fetch(`${API_BASE}?${params.toString()}`);
            const data = await res.json();
            const tbody = document.getElementById('logList');

            if (!data.content || data.content.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">ì¡°íšŒëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = data.content.map(log => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="font-bold">${log.serviceName}</div>
                        <div class="text-[10px] text-gray-400 font-mono">${log.logLevel || 'UNKNOWN'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="truncate max-w-xs" title="${log.summary}">${log.summary}</div>
                    </td>
                    <td class="px-6 py-4">
                        <select onchange="updateStatus(${log.logId}, this.value)" class="border rounded p-1 text-xs">
                            <option value="NEW" ${log.status === 'NEW' ? 'selected' : ''}>NEW</option>
                            <option value="ACKNOWLEDGED" ${log.status === 'ACKNOWLEDGED' ? 'selected' : ''}>ACK</option>
                            <option value="RESOLVED" ${log.status === 'RESOLVED' ? 'selected' : ''}>RESOLVED</option>
                        </select>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="alert('Hash: ${log.logHash}')" class="text-blue-600 hover:underline text-xs">ìƒì„¸</button>
                    </td>
                </tr>
            `).join('');
        } catch (e) {
            console.error("LoadLogs Error:", e);
        }
    }

    // ìˆ˜ë™ ë¡œê·¸ ë“±ë¡
    async function createLog() {
        const payload = {
            serviceName: document.getElementById('newService').value,
            logLevel: document.getElementById('newLogLevel').value,
            message: document.getElementById('newMessage').value,
            hostName: document.getElementById('newHost').value
        };

        if (!payload.serviceName || !payload.message) {
            alert("ì„œë¹„ìŠ¤ëª…ê³¼ ë©”ì‹œì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
            return;
        }

        try {
            const res = await fetch(API_BASE, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("ë“±ë¡ ìš”ì²­ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.");
                // ì…ë ¥ í¼ ì´ˆê¸°í™”
                ['newService', 'newLogLevel', 'newHost', 'newMessage'].forEach(id => document.getElementById(id).value = '');
                loadLogs();
            } else {
                const err = await res.json();
                alert("ë“±ë¡ ì‹¤íŒ¨: " + (err.message || "ì¡°ê±´ì„ í™•ì¸í•˜ì„¸ìš”."));
            }
        } catch (e) {
            alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    async function updateStatus(id, status) {
        try {
            const res = await fetch(`${API_BASE}/${id}/status?newStatus=${status}`, { method: 'PATCH' });
            if (res.ok) {
                alert(`ìƒíƒœê°€ ${status}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                loadLogs();
            }
        } catch (e) {
            alert("ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ì¸ì‹œë˜íŠ¸ ë¡œë“œ
    async function loadIncidents() {
        const res = await fetch('/api/incidents');
        const data = await res.json();
        const tbody = document.getElementById('incidentList');
        tbody.innerHTML = data.content.map(inc => `
            <tr>
                <td class="px-6 py-4">${inc.id}</td>
                <td class="px-6 py-4">${inc.serviceName}</td>
                <td class="px-6 py-4 truncate max-w-xs">${inc.title}</td>
                <td class="px-6 py-4 font-bold text-orange-600">${inc.status}</td>
            </tr>
        `).join('');
    }

    // KB Draft ë¡œë“œ
    async function loadKb() {
        const res = await fetch('/api/kb');
        const data = await res.json();
        const tbody = document.getElementById('kbList');
        tbody.innerHTML = data.content.map(kb => `
            <tr>
                <td class="px-6 py-4">${kb.id}</td>
                <td class="px-6 py-4 font-bold">${kb.title}</td>
                <td class="px-6 py-4"><span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">${kb.status}</span></td>
                <td class="px-6 py-4 text-gray-500">${new Date(kb.createdAt).toLocaleDateString()}</td>
            </tr>
        `).join('');
    }

    // ì´ˆê¸° ì‹¤í–‰
    window.onload = loadLogs;
</script>
</body>
</html>